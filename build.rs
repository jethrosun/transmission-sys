use std::env;
use std::path::PathBuf;

use bindgen;
use cmake;

fn main() {
    // This links a system-installed libtransmission
    // Uncomment if you want to use the system version
    /*
    println!("cargo:rustc-link-lib=transmission");
    println!("cargo:rustc-link-lib=crypto");
    println!("cargo:rustc-link-lib=z");
    println!("cargo:rustc-link-lib=dylib=event");
    println!("cargo:rustc-link-lib=dylib=event_core");
    println!("cargo:rustc-link-lib=dylib=event_extra");

    // This builds and links the bundled libtransmission
    // Comment until indicated if you want to use the system version
    */
    let dst = cmake::Config::new("vendor")
        // Turn everything we don't want off
        .define("ENABLE_DAEMON", "OFF")
        .define("ENABLE_GTK", "OFF")
        .define("ENABLE_QT", "OFF")
        .define("ENABLE_MAC", "OFF")
        .define("ENABLE_UTILS", "OFF")
        .define("ENABLE_CLI", "OFF")
        .define("ENABLE_TESTS", "OFF")
        .define("ENABLE_LIGHTWEIGHT", "OFF")
        .define("ENABLE_NLS", "OFF")
        .define("INSTALL_DOC", "OFF")
        .define("USE_SYSTEM_DHT", "OFF")
        .define("USE_SYSTEM_MINIUPNPC", "OFF")
        .define("USE_SYSTEM_NATPMP", "OFF")
        .define("USE_SYSTEM_UTP", "OFF")
        .define("USE_SYSTEM_B64", "OFF")
        .define("WITH_INOTIFY", "OFF")
        .define("WITH_KQUEUE", "OFF")
        .define("WITH_LIBAPPINDICATOR", "OFF")
        .define("WITH_SYSTEMD", "OFF")
        // Turn a few things on
        .define("ENABLE_UTP", "ON")
        .define("INSTALL_LIB", "ON")
        .define("WITH_CRYPTO", "openssl")
        // This is until Transmission fixes it
        .define("USE_SYSTEM_EVENT2", "ON")
        .build();
    
    let dst_natpmp = cmake::Config::new("/vendor/third-party/libnatpmp").build();
    let dst_utp = cmake::Config::new("/vendor/third-party/libutp").build();
    let dst_miniupnpc = cmake::Config::new("/vendor/third-party/miniupnpc").build();
    let dst_dht = cmake::Config::new("/vendor/third-party/dht").build();
    let dst_b64 = cmake::Config::new("/vendor/third-party/libb64").build();
    
    // Link transmission
    println!("cargo:rustc-link-search=native={}", dst.join("lib64").display());
    println!("cargo:rustc-link-lib=static=transmission");
    println!("cargo:rustc-link-search=native={}", dst_natpmp.join("lib").display());
    println!("cargo:rustc-link-lib=static=natpmp");
    println!("cargo:rustc-link-search=native={}", dst_utp.join("lib").display());
    println!("cargo:rustc-link-lib=static=utp");
    println!("cargo:rustc-link-search=native={}", dst_miniupnpc.join("lib").display());
    println!("cargo:rustc-link-lib=static=miniupnpc");
    println!("cargo:rustc-link-search=native={}", dst_dht.join("lib").display());
    println!("cargo:rustc-link-lib=static=dht");
    println!("cargo:rustc-link-search=native={}", dst_b64.join("lib").display());
    println!("cargo:rustc-link-lib=static=b64");
    println!("cargo:rustc-link-lib=crypto");
    println!("cargo:rustc-link-lib=z");
    println!("cargo:rustc-link-lib=curl");
    println!("cargo:rustc-link-lib=dylib=event");
    println!("cargo:rustc-link-lib=dylib=event_core");
    println!("cargo:rustc-link-lib=dylib=event_extra");
    // Stop commenting here if using the system version
    let bindings = bindgen::Builder::default()
        .header("wrapper.h")
        // Comment out to enable layout tests
        // These are autogenerated so may fail for no reason
        .layout_tests(false)
        .generate()
        .expect("Failed to generate bindings");

    let out_path = PathBuf::from(env::var("OUT_DIR").unwrap());
    bindings
        .write_to_file(out_path.join("bindings.rs"))
        .expect("Failed to write bindings");
}
